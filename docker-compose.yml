services:
  kafka:
    image: confluentinc/cp-kafka:7.6.1
    ports:
      - "9092:9092"
    environment:
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:29093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,CONTROLLER://0.0.0.0:29093,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"

  topic-init:
    image: confluentinc/cp-kafka:7.6.1
    depends_on:
      - kafka
    volumes:
      - ./scripts/create-topics.sh:/create-topics.sh:ro
    entrypoint: ["/bin/bash", "/create-topics.sh"]
    environment:
      BOOTSTRAP_SERVER: kafka:29092

  burrow:
    image: ghcr.io/linkedin/burrow/burrow:latest
    depends_on:
      - kafka
      - topic-init
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./config/burrow:/etc/burrow:ro

  kafka-exporter:
    image: danielqsj/kafka-exporter:v1.9.0
    depends_on:
      - kafka
    restart: unless-stopped
    ports:
      - "9308:9308"
    command:
      - "--kafka.server=kafka:29092"
      - "--topic.filter=^demo\\..*$"
      - "--group.filter=^demo-.*$"
      - "--offset.show-all"

  klag:
    image: themoah/klag:0.1.8-main
    platform: linux/amd64
    entrypoint:
      - java
      - -cp
      - /app/config:app.jar
      - io.github.themoah.klag.KlagLauncher
    depends_on:
      - kafka
      - topic-init
    restart: unless-stopped
    ports:
      - "8888:8888"
    volumes:
      - ./config/klag/application.properties:/app/config/application.properties:ro
    environment:
      METRICS_REPORTER: prometheus
      METRICS_INTERVAL_MS: 10000
      METRICS_GROUP_FILTER: demo-*

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.3
    restart: unless-stopped
    ports:
      - "9200:9200"
    environment:
      discovery.type: single-node
      xpack.security.enabled: "false"
      xpack.security.enrollment.enabled: "false"
      xpack.license.self_generated.type: basic
      ES_JAVA_OPTS: "-Xms512m -Xmx512m"

  es-metrics-indexer:
    build:
      context: ./es-metrics-indexer
    depends_on:
      - elasticsearch
      - kafka-exporter
      - burrow
      - klag
    restart: unless-stopped
    environment:
      ELASTICSEARCH_URL: http://elasticsearch:9200
      KAFKA_EXPORTER_URL: http://kafka-exporter:9308/metrics
      BURROW_BASE_URL: http://burrow:8000
      KLAG_METRICS_URL: http://klag:8888/metrics
      INDEX_PREFIX: kafka-burrow-metrics
      POLL_INTERVAL_SECONDS: 5
      REQUEST_TIMEOUT_SECONDS: 5

  grafana:
    image: grafana/grafana:11.1.4
    depends_on:
      - elasticsearch
      - es-metrics-indexer
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Editor
    volumes:
      - ./config/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./config/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards:ro

  traffic-simulator:
    build:
      context: ./simulator
    depends_on:
      - kafka
      - topic-init
    restart: unless-stopped
    environment:
      BOOTSTRAP_SERVERS: kafka:29092
      PRODUCE_INTERVAL_SECONDS: 0.5
      PRODUCE_INTERVAL_HEALTHY_SECONDS: 0.015
      PRODUCE_INTERVAL_SLOW_SECONDS: 0.25
      PRODUCE_INTERVAL_STOPPED_SECONDS: 0.35
      PRODUCE_INTERVAL_BURSTY_SECONDS: 0.05
      PRODUCE_INTERVAL_RISK_SECONDS: 0.08
      HEALTHY_CONSUMER_MAX_POLL_RECORDS: 500
      HEALTHY_CONSUMER_BATCH_SLEEP_SHORT_SECONDS: 0.15
      HEALTHY_CONSUMER_BATCH_SLEEP_LONG_SECONDS: 1.2
      HEALTHY_CONSUMER_LONG_SLEEP_EVERY_BATCHES: 6
      SLOW_CONSUMER_SLEEP_SECONDS: 8
      SLOW_CONSUMER_MAX_POLL_RECORDS: 1
      STOPPED_CONSUMER_RUNTIME_SECONDS: 90
      BURSTY_CONSUMER_MAX_POLL_RECORDS: 20
      BURSTY_CONSUMER_FAST_SLEEP_SECONDS: 0.02
      BURSTY_CONSUMER_SLOW_SLEEP_SECONDS: 1.3
      BURSTY_CONSUMER_CYCLE_SECONDS: 70
      BURSTY_CONSUMER_FAST_SECONDS: 25
      RISK_CONSUMER_MAX_POLL_RECORDS: 200
      RISK_CONSUMER_ACTIVE_SECONDS: 35
      RISK_CONSUMER_PAUSE_SECONDS: 150
      RISK_CONSUMER_ACTIVE_SLEEP_SECONDS: 0.08
      HEALTHY_TOPIC: demo.healthy
      SLOW_TOPIC: demo.slow
      STOPPED_TOPIC: demo.stopped
      BURSTY_TOPIC: demo.bursty
      RISK_TOPIC: demo.risk
      HEALTHY_GROUP: demo-healthy-group
      SLOW_GROUP: demo-slow-group
      STOPPED_GROUP: demo-stopped-group
      BURSTY_GROUP: demo-bursty-group
      RISK_GROUP: demo-risk-group
